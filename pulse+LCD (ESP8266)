#include <PulseSensorPlayground.h>     // Includes the PulseSensorPlayground Library
#include <LiquidCrystal.h>             // Includes the LCD Library

// PulseSensor Variables
const int PulseWire = 0;       // PulseSensor PURPLE WIRE connected to ANALOG PIN 0
const int LED = LED_BUILTIN;   // The on-board Arduino LED, close to PIN 13
int Threshold = 550;           // Determine which Signal to "count as a beat" and which to ignore

// LCD Variables
const int rs = 12, en = 11, d4 = 5, d5 = 4, d6 = 3, d7 = 2;
LiquidCrystal lcd(rs, en, d4, d5, d6, d7);

// Custom heart character
byte heartChar[8] = {
  0b00000,
  0b01010,
  0b11111,
  0b11111,
  0b11111,
  0b01110,
  0b00100,
  0b00000
};

// Variables for timing
unsigned long lastUpdateTime = 0;
const unsigned long updateInterval = 2500; // 2.5 seconds in milliseconds

// Create a PulseSensor object
PulseSensorPlayground pulseSensor;

void setup() {
  Serial.begin(115200);          // For Serial Monitor
  
  // Initialize LCD
  lcd.begin(16, 2);              // Set up the LCD's number of columns and rows
  lcd.createChar(0, heartChar);  // Create custom heart character
  
  // Display startup message
  lcd.setCursor(0, 0);
  lcd.print("BPM Monitor");
  lcd.setCursor(0, 1);
  lcd.print("Initializing...");
  
  // Configure the PulseSensor object
  pulseSensor.analogInput(PulseWire);   
  pulseSensor.blinkOnPulse(LED);        // Auto-magically blink Arduino's LED with heartbeat
  pulseSensor.setThreshold(Threshold);   

  // Start the PulseSensor
  if (pulseSensor.begin()) {
    Serial.println("PulseSensor initialized!");
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("BPM: ---");
    lcd.setCursor(0, 1);
    lcd.print("Ready...");
  } else {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Sensor Error!");
    while(1); // If sensor failed to start, halt program
  }
  
  delay(2000); // Short delay to read the startup message
  lcd.clear();
}

void loop() {
  // Get the current time
  unsigned long currentTime = millis();
  
  // Process any available heartbeats
  int myBPM = pulseSensor.getBeatsPerMinute();
  
  // Check if it's time to update the display (every 2.5 seconds)
  if (currentTime - lastUpdateTime >= updateInterval) {
    lastUpdateTime = currentTime;
    
    // Clear the first row and display BPM
    lcd.setCursor(0, 0);
    lcd.print("BPM: ");
    
    // Only display BPM if it's in a reasonable range
    if (myBPM > 30 && myBPM < 200) {
      // Print BPM value with leading spaces for alignment
      if (myBPM < 100) {
        lcd.print(" ");
      }
      lcd.print(myBPM);
      
      // Display heart character at positions 12-16
      for (int i = 12; i <= 16; i++) {
        lcd.setCursor(i, 0);
        lcd.write(byte(0)); // Display the custom heart
      }
    } else {
      lcd.print("---");
      // Clear heart positions in case they were set before
      lcd.setCursor(12, 0);
      lcd.print("     ");
    }
    
    /* Update second row with the detection status
    lcd.setCursor(0, 1);
    if (pulseSensor.sawStartOfBeat()) {
      lcd.print("Pulse Detected   ");
    } else {
      lcd.print("Monitoring...    ");
    }*/
  }
  
  // If a beat happened, print to Serial for debugging
  if (pulseSensor.sawStartOfBeat()) {
    Serial.println("â™¥  A HeartBeat Happened!");
    Serial.print("BPM: ");
    Serial.println(myBPM);
  }
  
  delay(20); // Short delay for stability
}
